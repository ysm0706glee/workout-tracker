<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Iron Log — Workout Tracker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #141420;
    --surface2: #1c1c2e;
    --border: #2a2a40;
    --primary: #6c5ce7;
    --primary-light: #a29bfe;
    --accent: #00cec9;
    --text: #e8e8f0;
    --text-dim: #8888a0;
    --danger: #ff6b6b;
    --success: #51cf66;
    --warning: #ffd43b;
    --gold: #f0a500;
    --radius: 14px;
    --radius-sm: 8px;
  }
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg); color: var(--text);
    min-height: 100dvh; overflow-x: hidden; padding-bottom: 80px;
  }

  /* ── Top Bar ── */
  .topbar {
    position:sticky; top:0; z-index:50;
    background:rgba(10,10,15,0.85); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
    padding:16px 20px 12px; border-bottom:1px solid var(--border);
    display:flex; justify-content:space-between; align-items:center;
  }
  .topbar h1 { font-size:22px; font-weight:700; letter-spacing:-0.5px; }
  .topbar h1 span { color:var(--primary-light); }

  /* ── Bottom Nav ── */
  .bottom-nav {
    position:fixed; bottom:0; left:0; right:0; z-index:50;
    background:rgba(20,20,32,0.92); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
    border-top:1px solid var(--border); display:flex; align-items:flex-end;
    padding:8px 0 max(8px, env(safe-area-inset-bottom));
  }
  .nav-item {
    flex:1; display:flex; flex-direction:column; align-items:center;
    gap:4px; padding:6px 0; cursor:pointer; border:none; background:none;
    color:var(--text-dim); font-size:10px; font-weight:500; transition:color 0.2s;
  }
  .nav-item.active { color:var(--primary-light); }
  .nav-item svg { width:22px; height:22px; }
  .nav-item.nav-center svg { width:28px; height:28px; }
  .nav-item.nav-center {
    margin-top:-18px; background:var(--primary); width:52px; height:52px;
    flex:0 0 52px; border-radius:50%; justify-content:center; gap:0; padding:0; color:white;
    box-shadow:0 4px 20px rgba(108,92,231,0.5);
  }
  .nav-item.nav-center span { display:none; }

  /* ── Pages ── */
  .page { display:none; padding:20px; animation:fadeIn 0.25s ease; }
  .page.active { display:block; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

  /* ── Cards ── */
  .card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:18px; margin-bottom:14px; }
  .card-title { font-size:13px; font-weight:600; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.8px; margin-bottom:12px; }

  /* ── Stats ── */
  .stats-row { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:14px; }
  .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:16px 14px; text-align:center; }
  .stat-value { font-size:26px; font-weight:700; color:var(--primary-light); }
  .stat-label { font-size:11px; color:var(--text-dim); margin-top:4px; text-transform:uppercase; letter-spacing:0.5px; }

  /* ── Buttons ── */
  .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:14px 24px; border-radius:var(--radius-sm); font-size:15px; font-weight:600; border:none; cursor:pointer; transition:all 0.2s; width:100%; }
  .btn-primary { background:var(--primary); color:white; }
  .btn-primary:hover { background:#5b4bd6; }
  .btn-primary:active { transform:scale(0.97); }
  .btn-secondary { background:var(--surface2); color:var(--text); border:1px solid var(--border); }
  .btn-accent { background:var(--accent); color:var(--bg); }
  .btn-danger { background:rgba(255,107,107,0.15); color:var(--danger); border:1px solid rgba(255,107,107,0.3); }
  .btn-sm { padding:8px 14px; font-size:13px; width:auto; }
  .btn-row { display:flex; gap:8px; }
  .btn-row .btn { flex:1; }

  /* ── Form ── */
  .form-group { margin-bottom:16px; }
  .form-label { display:block; font-size:13px; font-weight:600; color:var(--text-dim); margin-bottom:6px; }
  .form-input, .form-select {
    width:100%; padding:12px 14px; background:var(--surface2);
    border:1px solid var(--border); border-radius:var(--radius-sm);
    color:var(--text); font-size:15px; outline:none; transition:border-color 0.2s;
  }
  .form-input:focus, .form-select:focus { border-color:var(--primary); }
  .form-select { appearance:none; cursor:pointer; }
  select option { background:var(--surface2); color:var(--text); }
  textarea.form-input { resize:vertical; min-height:60px; }

  /* ── Set Row ── */
  .set-row { display:grid; grid-template-columns:40px 1fr 1fr 40px; gap:8px; align-items:center; margin-bottom:8px; }
  .set-num { width:32px; height:32px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:700; }
  .set-input { padding:10px 12px; background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius-sm); color:var(--text); font-size:15px; text-align:center; outline:none; width:100%; }
  .set-input:focus { border-color:var(--primary); }
  .remove-set { width:32px; height:32px; border-radius:50%; background:rgba(255,107,107,0.1); border:none; color:var(--danger); cursor:pointer; font-size:18px; display:flex; align-items:center; justify-content:center; }

  /* ── Exercise Block ── */
  .exercise-block { background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius); padding:16px; margin-bottom:12px; }
  .exercise-block-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
  .exercise-block-title { font-size:16px; font-weight:600; }
  .last-time { font-size:12px; color:var(--accent); margin-bottom:10px; padding:6px 10px; background:rgba(0,206,201,0.08); border-radius:6px; border:1px solid rgba(0,206,201,0.15); }
  .last-time strong { color:var(--accent); }
  .set-labels { display:grid; grid-template-columns:40px 1fr 1fr 40px; gap:8px; margin-bottom:6px; font-size:11px; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.5px; }
  .set-labels span:nth-child(2), .set-labels span:nth-child(3) { text-align:center; }

  /* ── Routine Cards ── */
  .routine-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:18px; margin-bottom:12px; transition:border-color 0.2s; }
  .routine-card:hover { border-color:var(--primary); }
  .routine-name { font-size:17px; font-weight:700; margin-bottom:6px; }
  .routine-exercises { font-size:13px; color:var(--text-dim); margin-bottom:12px; line-height:1.5; }
  .routine-actions { display:flex; gap:8px; }

  /* ── Routine Builder ── */
  .routine-exercise-item { display:flex; align-items:center; gap:10px; padding:12px; background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius-sm); margin-bottom:8px; }
  .routine-exercise-item .name { flex:1; font-size:14px; font-weight:600; }
  .routine-exercise-item input { width:60px; padding:8px; background:var(--bg); border:1px solid var(--border); border-radius:6px; color:var(--text); font-size:14px; text-align:center; outline:none; }
  .routine-exercise-item input:focus { border-color:var(--primary); }
  .routine-exercise-item .x-label { font-size:12px; color:var(--text-dim); }

  /* ── History ── */
  .history-item { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:16px; margin-bottom:10px; cursor:pointer; transition:border-color 0.2s; }
  .history-item:hover { border-color:var(--primary); }
  .history-date { font-size:13px; color:var(--primary-light); font-weight:600; margin-bottom:4px; }
  .history-summary { font-size:14px; color:var(--text-dim); }
  .history-detail { margin-top:10px; padding-top:10px; border-top:1px solid var(--border); display:none; }
  .history-detail.open { display:block; }
  .history-exercise { margin-bottom:8px; }
  .history-exercise-name { font-size:14px; font-weight:600; margin-bottom:4px; }
  .history-set-line { font-size:13px; color:var(--text-dim); padding-left:12px; }

  /* ── Progress ── */
  .exercise-chips { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px; }
  .chip { padding:8px 14px; border-radius:20px; font-size:13px; font-weight:500; background:var(--surface2); border:1px solid var(--border); color:var(--text-dim); cursor:pointer; transition:all 0.2s; }
  .chip.active { background:var(--primary); border-color:var(--primary); color:white; }
  .chart-container { position:relative; height:260px; margin-top:10px; }

  /* ── PR Badge ── */
  .pr-card { display:flex; align-items:center; gap:14px; padding:16px; background:linear-gradient(135deg, rgba(240,165,0,0.1), rgba(108,92,231,0.1)); border:1px solid rgba(240,165,0,0.3); border-radius:var(--radius); margin-bottom:14px; }
  .pr-icon { font-size:28px; }
  .pr-info { flex:1; }
  .pr-label { font-size:12px; color:var(--gold); text-transform:uppercase; letter-spacing:1px; font-weight:700; }
  .pr-value { font-size:22px; font-weight:700; color:var(--text); margin-top:2px; }
  .pr-date { font-size:12px; color:var(--text-dim); margin-top:2px; }

  /* ── Muscle Group ── */
  .muscle-group-header { font-size:14px; font-weight:700; color:var(--primary-light); text-transform:uppercase; letter-spacing:1px; padding:12px 0 8px; border-bottom:1px solid var(--border); margin-bottom:8px; margin-top:16px; }
  .muscle-group-header:first-child { margin-top:0; }
  .exercise-lib-item { display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid rgba(42,42,64,0.5); cursor:pointer; }
  .exercise-lib-name { font-size:15px; }

  /* ── Modal ── */
  .modal-overlay { display:none; position:fixed; inset:0; z-index:100; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); align-items:flex-end; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal { background:var(--surface); border-radius:var(--radius) var(--radius) 0 0; padding:24px 20px max(20px, env(safe-area-inset-bottom)); width:100%; max-width:500px; max-height:70vh; overflow-y:auto; animation:slideUp 0.3s ease; }
  @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
  .modal-title { font-size:18px; font-weight:700; margin-bottom:16px; }

  /* ── Toggle ── */
  .unit-toggle { display:flex; background:var(--surface2); border-radius:var(--radius-sm); border:1px solid var(--border); overflow:hidden; margin-bottom:16px; }
  .unit-toggle button { flex:1; padding:10px; border:none; background:none; color:var(--text-dim); font-size:13px; font-weight:600; cursor:pointer; }
  .unit-toggle button.active { background:var(--primary); color:white; }

  /* ── Empty State ── */
  .empty-state { text-align:center; padding:40px 20px; color:var(--text-dim); }
  .empty-state p { font-size:15px; margin-bottom:16px; }

  /* ── Start Modal ── */
  .start-option { padding:16px; background:var(--surface2); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:10px; cursor:pointer; transition:all 0.2s; }
  .start-option:hover, .start-option:active { border-color:var(--primary); background:rgba(108,92,231,0.08); }
  .start-option-title { font-size:16px; font-weight:600; margin-bottom:4px; }
  .start-option-desc { font-size:13px; color:var(--text-dim); }

  /* ── Delete ── */
  .delete-workout { margin-top:8px; padding:6px 12px; border-radius:6px; background:rgba(255,107,107,0.1); border:1px solid rgba(255,107,107,0.2); color:var(--danger); font-size:12px; font-weight:600; cursor:pointer; }

  /* ── Scrollbar ── */
  ::-webkit-scrollbar { width:4px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:4px; }

  /* ── Est 1RM ── */
  .onerm-row { display:flex; gap:10px; margin-bottom:10px; }
  .onerm-card { flex:1; text-align:center; padding:10px; background:var(--surface2); border-radius:var(--radius-sm); border:1px solid var(--border); }
  .onerm-val { font-size:20px; font-weight:700; color:var(--primary-light); }
  .onerm-label { font-size:10px; color:var(--text-dim); text-transform:uppercase; margin-top:2px; }
</style>
</head>
<body>

<!-- Top Bar -->
<div class="topbar">
  <h1>Iron<span>Log</span></h1>
</div>

<!-- Page: Dashboard -->
<div class="page active" id="page-dashboard">
  <div class="stats-row">
    <div class="stat-card"><div class="stat-value" id="stat-total">0</div><div class="stat-label">Workouts</div></div>
    <div class="stat-card"><div class="stat-value" id="stat-week">0</div><div class="stat-label">This Week</div></div>
    <div class="stat-card"><div class="stat-value" id="stat-streak">0</div><div class="stat-label">Day Streak</div></div>
  </div>
  <button class="btn btn-primary" onclick="openStartModal()" style="margin-bottom:14px;">
    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="10" y1="4" x2="10" y2="16"/><line x1="4" y1="10" x2="16" y2="10"/></svg>
    Start Workout
  </button>
  <div class="card">
    <div class="card-title">Recent Workouts</div>
    <div id="recent-workouts"></div>
  </div>
</div>

<!-- Page: Routines -->
<div class="page" id="page-routines">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <h2 style="font-size:18px;font-weight:700;">My Routines</h2>
    <button class="btn btn-primary btn-sm" onclick="openRoutineBuilder()">+ New Routine</button>
  </div>
  <div id="routines-list"></div>
</div>

<!-- Page: Log Workout -->
<div class="page" id="page-log">
  <div class="unit-toggle">
    <button id="unit-kg" class="active" onclick="setUnit('kg')">Kilograms (kg)</button>
    <button id="unit-lb" onclick="setUnit('lb')">Pounds (lb)</button>
  </div>
  <div id="workout-exercises"></div>
  <button class="btn btn-secondary" onclick="openExercisePicker()" style="margin-bottom:12px;">
    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="9" y1="3" x2="9" y2="15"/><line x1="3" y1="9" x2="15" y2="9"/></svg>
    Add Exercise
  </button>
  <div class="form-group">
    <label class="form-label">Notes (optional)</label>
    <textarea class="form-input" id="workout-notes" placeholder="How did it feel?"></textarea>
  </div>
  <button class="btn btn-primary" onclick="saveWorkout()">Save Workout</button>
</div>

<!-- Page: History -->
<div class="page" id="page-history">
  <div id="history-list"></div>
</div>

<!-- Page: Progress -->
<div class="page" id="page-progress">
  <div class="card">
    <div class="card-title">Select Exercise</div>
    <div class="exercise-chips" id="progress-chips"></div>
  </div>
  <div id="pr-section"></div>
  <div class="card">
    <div class="card-title">Max Weight Over Time</div>
    <div class="chart-container"><canvas id="chart-weight"></canvas></div>
  </div>
  <div class="card">
    <div class="card-title">Total Volume Per Session</div>
    <div class="chart-container"><canvas id="chart-volume"></canvas></div>
  </div>
</div>

<!-- Start Workout Modal -->
<div class="modal-overlay" id="start-modal">
  <div class="modal">
    <div class="modal-title">Start Workout</div>
    <div class="start-option" onclick="startEmptyWorkout()">
      <div class="start-option-title">Empty Workout</div>
      <div class="start-option-desc">Build your workout from scratch</div>
    </div>
    <div id="start-routine-list"></div>
    <button class="btn btn-secondary" onclick="closeStartModal()" style="margin-top:8px;">Cancel</button>
  </div>
</div>

<!-- Exercise Picker Modal -->
<div class="modal-overlay" id="exercise-picker-modal">
  <div class="modal">
    <div class="modal-title">Choose Exercise</div>
    <div class="form-group">
      <input class="form-input" type="text" id="picker-search" placeholder="Search..." oninput="filterPicker()">
    </div>
    <div id="picker-list"></div>
    <button class="btn btn-secondary" onclick="closeExercisePicker()" style="margin-top:12px;">Cancel</button>
  </div>
</div>

<!-- Routine Builder Modal -->
<div class="modal-overlay" id="routine-builder-modal">
  <div class="modal" style="max-height:85vh;">
    <div class="modal-title" id="routine-builder-title">New Routine</div>
    <div class="form-group">
      <label class="form-label">Routine Name</label>
      <input class="form-input" type="text" id="routine-name-input" placeholder="e.g. Push Day, Leg Day...">
    </div>
    <div class="card-title">Exercises</div>
    <div id="routine-builder-exercises"></div>
    <button class="btn btn-secondary btn-sm" onclick="openRoutineExercisePicker()" style="margin-bottom:16px;width:100%;">+ Add Exercise</button>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="closeRoutineBuilder()">Cancel</button>
      <button class="btn btn-primary" onclick="saveRoutine()">Save Routine</button>
    </div>
  </div>
</div>

<!-- Routine Exercise Picker Modal -->
<div class="modal-overlay" id="routine-exercise-picker-modal" style="z-index:110;">
  <div class="modal">
    <div class="modal-title">Add Exercise to Routine</div>
    <div class="form-group">
      <input class="form-input" type="text" id="routine-picker-search" placeholder="Search..." oninput="filterRoutinePicker()">
    </div>
    <div id="routine-picker-list"></div>
    <button class="btn btn-secondary" onclick="closeRoutineExercisePicker()" style="margin-top:12px;">Cancel</button>
  </div>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav">
  <button class="nav-item active" onclick="showPage('dashboard')" id="nav-dashboard">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    <span>Home</span>
  </button>
  <button class="nav-item" onclick="showPage('routines')" id="nav-routines">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
    <span>Routines</span>
  </button>
  <button class="nav-item nav-center" onclick="openStartModal()" id="nav-log">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    <span>Log</span>
  </button>
  <button class="nav-item" onclick="showPage('history')" id="nav-history">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    <span>History</span>
  </button>
  <button class="nav-item" onclick="showPage('progress')" id="nav-progress">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
    <span>Progress</span>
  </button>
</nav>

<script>
// ══════════════════════════════════════
//  DATA
// ══════════════════════════════════════
const DEFAULT_EXERCISES = {
  Chest: ['Bench Press','Incline Bench Press','Dumbbell Fly','Cable Crossover','Push-Up','Dumbbell Press'],
  Back: ['Deadlift','Barbell Row','Lat Pulldown','Seated Cable Row','Pull-Up','T-Bar Row'],
  Shoulders: ['Overhead Press','Lateral Raise','Front Raise','Face Pull','Arnold Press','Reverse Fly'],
  Arms: ['Barbell Curl','Dumbbell Curl','Hammer Curl','Tricep Pushdown','Skull Crusher','Dip'],
  Legs: ['Squat','Leg Press','Romanian Deadlift','Leg Curl','Leg Extension','Calf Raise','Lunge','Bulgarian Split Squat'],
  Core: ['Plank','Cable Crunch','Hanging Leg Raise','Ab Wheel Rollout','Russian Twist']
};

const load = (k, fb) => { try { const d=localStorage.getItem(k); return d?JSON.parse(d):fb; } catch{return fb;} };
const save = (k, d) => localStorage.setItem(k, JSON.stringify(d));

let workouts = load('il_workouts', []);
let exercises = load('il_exercises', JSON.parse(JSON.stringify(DEFAULT_EXERCISES)));
let routines = load('il_routines', []);
let unit = load('il_unit', 'kg');
let currentWorkout = [];
let weightChart = null, volumeChart = null;
let selectedProgressExercise = null;
let editingRoutineId = null;
let routineBuilderExercises = [];

// ══════════════════════════════════════
//  NAVIGATION
// ══════════════════════════════════════
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  const navEl = document.getElementById('nav-'+page);
  if (navEl) navEl.classList.add('active');
  if (page==='dashboard') refreshDashboard();
  if (page==='routines') refreshRoutines();
  if (page==='history') refreshHistory();
  if (page==='progress') refreshProgress();
}

function formatDate(ds) {
  return new Date(ds+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
}

// ══════════════════════════════════════
//  DASHBOARD
// ══════════════════════════════════════
function refreshDashboard() {
  document.getElementById('stat-total').textContent = workouts.length;
  const now=new Date(), ws=new Date(now); ws.setDate(now.getDate()-now.getDay()); ws.setHours(0,0,0,0);
  document.getElementById('stat-week').textContent = workouts.filter(w=>new Date(w.date)>=ws).length;

  let streak=0;
  if (workouts.length) {
    const today=new Date(); today.setHours(0,0,0,0);
    const dates=new Set(workouts.map(w=>w.date));
    const ts=today.toISOString().split('T')[0];
    const yd=new Date(today); yd.setDate(yd.getDate()-1);
    const ys=yd.toISOString().split('T')[0];
    let cd;
    if (dates.has(ts)) { streak=1; cd=new Date(today); cd.setDate(cd.getDate()-1); }
    else if (dates.has(ys)) { streak=1; cd=new Date(yd); cd.setDate(cd.getDate()-1); }
    if (cd) { while(dates.has(cd.toISOString().split('T')[0])){streak++;cd.setDate(cd.getDate()-1);} }
  }
  document.getElementById('stat-streak').textContent = streak;

  const recent = document.getElementById('recent-workouts');
  const last5 = [...workouts].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);
  if (!last5.length) { recent.innerHTML='<div class="empty-state"><p>No workouts yet. Tap + to begin!</p></div>'; return; }
  recent.innerHTML = last5.map(w => {
    const names=w.exercises.map(e=>e.name).join(', ');
    const sets=w.exercises.reduce((s,e)=>s+e.sets.length,0);
    return `<div class="history-item" style="cursor:default"><div class="history-date">${formatDate(w.date)}</div><div class="history-summary">${names} · ${sets} sets</div></div>`;
  }).join('');
}

// ══════════════════════════════════════
//  START WORKOUT MODAL
// ══════════════════════════════════════
function openStartModal() {
  const list = document.getElementById('start-routine-list');
  if (!routines.length) {
    list.innerHTML='<div style="text-align:center;padding:16px 0;color:var(--text-dim);font-size:13px;">No routines yet. <a href="#" onclick="event.preventDefault();closeStartModal();showPage(\'routines\')" style="color:var(--primary-light);">Create one</a></div>';
  } else {
    list.innerHTML = routines.map(r => {
      const exNames = r.exercises.map(e=>e.name).slice(0,4).join(', ') + (r.exercises.length>4?' ...':'');
      return `<div class="start-option" onclick="startFromRoutine('${r.id}')">
        <div class="start-option-title">${esc(r.name)}</div>
        <div class="start-option-desc">${exNames}</div>
      </div>`;
    }).join('');
  }
  document.getElementById('start-modal').classList.add('open');
}
function closeStartModal() { document.getElementById('start-modal').classList.remove('open'); }

function startEmptyWorkout() {
  closeStartModal();
  currentWorkout = [];
  document.getElementById('workout-notes').value = '';
  renderWorkoutForm();
  showPage('log');
}

function startFromRoutine(id) {
  closeStartModal();
  const routine = routines.find(r=>r.id===id);
  if (!routine) return;
  currentWorkout = routine.exercises.map(e => {
    const sets = [];
    for (let i=0; i<(e.defaultSets||3); i++) sets.push({ weight:'', reps: e.defaultReps||'' });
    return { name: e.name, sets };
  });
  document.getElementById('workout-notes').value = '';
  renderWorkoutForm();
  showPage('log');
}

// ══════════════════════════════════════
//  ROUTINES
// ══════════════════════════════════════
function refreshRoutines() {
  const list = document.getElementById('routines-list');
  if (!routines.length) {
    list.innerHTML='<div class="empty-state"><p>No routines yet. Create your first routine to speed up logging at the gym!</p></div>';
    return;
  }
  list.innerHTML = routines.map(r => {
    const exList = r.exercises.map(e=>`${e.name} (${e.defaultSets}×${e.defaultReps})`).join(', ');
    return `<div class="routine-card">
      <div class="routine-name">${esc(r.name)}</div>
      <div class="routine-exercises">${exList}</div>
      <div class="routine-actions">
        <button class="btn btn-accent btn-sm" onclick="startFromRoutine('${r.id}');showPage('log')">Start</button>
        <button class="btn btn-secondary btn-sm" onclick="editRoutine('${r.id}')">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="deleteRoutine('${r.id}')">Delete</button>
      </div>
    </div>`;
  }).join('');
}

function deleteRoutine(id) {
  if (!confirm('Delete this routine?')) return;
  routines = routines.filter(r=>r.id!==id);
  save('il_routines', routines);
  refreshRoutines();
}

function openRoutineBuilder(id) {
  editingRoutineId = id || null;
  if (id) {
    const r = routines.find(x=>x.id===id);
    document.getElementById('routine-name-input').value = r.name;
    routineBuilderExercises = r.exercises.map(e=>({...e}));
    document.getElementById('routine-builder-title').textContent = 'Edit Routine';
  } else {
    document.getElementById('routine-name-input').value = '';
    routineBuilderExercises = [];
    document.getElementById('routine-builder-title').textContent = 'New Routine';
  }
  renderRoutineBuilder();
  document.getElementById('routine-builder-modal').classList.add('open');
}
function closeRoutineBuilder() { document.getElementById('routine-builder-modal').classList.remove('open'); }
function editRoutine(id) { openRoutineBuilder(id); }

function renderRoutineBuilder() {
  const c = document.getElementById('routine-builder-exercises');
  if (!routineBuilderExercises.length) { c.innerHTML='<div class="empty-state" style="padding:20px"><p>Add exercises to this routine</p></div>'; return; }
  c.innerHTML = routineBuilderExercises.map((e,i) => `
    <div class="routine-exercise-item">
      <span class="name">${e.name}</span>
      <input type="number" inputmode="numeric" value="${e.defaultSets}" min="1" onchange="routineBuilderExercises[${i}].defaultSets=parseInt(this.value)||1" placeholder="sets">
      <span class="x-label">sets ×</span>
      <input type="number" inputmode="numeric" value="${e.defaultReps}" min="1" onchange="routineBuilderExercises[${i}].defaultReps=parseInt(this.value)||1" placeholder="reps">
      <span class="x-label">reps</span>
      <button class="remove-set" onclick="routineBuilderExercises.splice(${i},1);renderRoutineBuilder()">×</button>
    </div>
  `).join('');
}

function saveRoutine() {
  const name = document.getElementById('routine-name-input').value.trim();
  if (!name) return alert('Give your routine a name.');
  if (!routineBuilderExercises.length) return alert('Add at least one exercise.');
  if (editingRoutineId) {
    const r = routines.find(x=>x.id===editingRoutineId);
    r.name = name; r.exercises = routineBuilderExercises.map(e=>({...e}));
  } else {
    routines.push({ id:Date.now().toString(36)+Math.random().toString(36).slice(2,6), name, exercises:routineBuilderExercises.map(e=>({...e})) });
  }
  save('il_routines', routines);
  closeRoutineBuilder();
  refreshRoutines();
}

function openRoutineExercisePicker() {
  document.getElementById('routine-picker-search').value='';
  renderRoutinePickerList();
  document.getElementById('routine-exercise-picker-modal').classList.add('open');
}
function closeRoutineExercisePicker() { document.getElementById('routine-exercise-picker-modal').classList.remove('open'); }
function filterRoutinePicker() { renderRoutinePickerList(document.getElementById('routine-picker-search').value); }

function renderRoutinePickerList(filter='') {
  const c=document.getElementById('routine-picker-list'); const f=(filter||'').toLowerCase(); let html='';
  for (const [group,exList] of Object.entries(exercises)) {
    const filtered=exList.filter(e=>e.toLowerCase().includes(f));
    if (!filtered.length) continue;
    html+=`<div class="muscle-group-header">${group}</div>`;
    filtered.forEach(name => {
      html+=`<div class="exercise-lib-item" onclick="pickRoutineExercise('${name.replace(/'/g,"\\'")}')"><span class="exercise-lib-name">${name}</span><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary-light)" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>`;
    });
  }
  c.innerHTML=html||'<div class="empty-state"><p>No exercises found</p></div>';
}

function pickRoutineExercise(name) {
  routineBuilderExercises.push({ name, defaultSets:3, defaultReps:10 });
  closeRoutineExercisePicker();
  renderRoutineBuilder();
}

// ══════════════════════════════════════
//  LOG WORKOUT
// ══════════════════════════════════════
function getLastPerformance(exerciseName) {
  const sorted = [...workouts].sort((a,b)=>new Date(b.date)-new Date(a.date));
  for (const w of sorted) {
    const ex = w.exercises.find(e=>e.name===exerciseName);
    if (ex) return { sets: ex.sets, unit: w.unit||'kg', date: w.date };
  }
  return null;
}

function renderWorkoutForm() {
  const c = document.getElementById('workout-exercises');
  if (!currentWorkout.length) { c.innerHTML='<div class="empty-state"><p>Add an exercise to begin</p></div>'; return; }
  c.innerHTML = currentWorkout.map((ex,ei) => {
    const last = getLastPerformance(ex.name);
    let lastHTML = '';
    if (last) {
      const lastSets = last.sets.map(s=>`${s.weight}${last.unit}×${s.reps}`).join(', ');
      lastHTML = `<div class="last-time"><strong>Last time:</strong> ${lastSets} <span style="color:var(--text-dim);font-size:11px;">(${formatDate(last.date)})</span></div>`;
    }
    const setsHTML = ex.sets.map((s,si) => `
      <div class="set-row">
        <div class="set-num">${si+1}</div>
        <input class="set-input" type="number" inputmode="decimal" placeholder="${unit}" value="${s.weight||''}" onchange="updateSet(${ei},${si},'weight',this.value)">
        <input class="set-input" type="number" inputmode="numeric" placeholder="reps" value="${s.reps||''}" onchange="updateSet(${ei},${si},'reps',this.value)">
        <button class="remove-set" onclick="removeSet(${ei},${si})">×</button>
      </div>
    `).join('');
    return `<div class="exercise-block">
      <div class="exercise-block-header">
        <div class="exercise-block-title">${ex.name}</div>
        <button class="btn btn-danger btn-sm" onclick="removeExercise(${ei})">Skip</button>
      </div>
      ${lastHTML}
      <div class="set-labels"><span></span><span>${unit}</span><span>Reps</span><span></span></div>
      ${setsHTML}
      <button class="btn btn-secondary btn-sm" onclick="addSet(${ei})" style="margin-top:8px;width:100%;">+ Add Set</button>
    </div>`;
  }).join('');
}

function addSet(ei) {
  const last=currentWorkout[ei].sets.at(-1);
  currentWorkout[ei].sets.push({weight:last?last.weight:'',reps:last?last.reps:''});
  renderWorkoutForm();
}
function removeSet(ei,si) {
  currentWorkout[ei].sets.splice(si,1);
  if(!currentWorkout[ei].sets.length) currentWorkout.splice(ei,1);
  renderWorkoutForm();
}
function removeExercise(i) { currentWorkout.splice(i,1); renderWorkoutForm(); }
function updateSet(ei,si,f,v) { currentWorkout[ei].sets[si][f]=parseFloat(v)||''; }

function saveWorkout() {
  const valid=currentWorkout.filter(ex=>ex.sets.some(s=>s.weight&&s.reps));
  if(!valid.length){alert('Add at least one exercise with weight and reps.');return;}
  const cleaned=valid.map(ex=>({name:ex.name,sets:ex.sets.filter(s=>s.weight&&s.reps).map(s=>({weight:parseFloat(s.weight),reps:parseInt(s.reps)}))}));
  workouts.push({
    id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),
    date:new Date().toISOString().split('T')[0],
    unit, exercises:cleaned,
    notes:document.getElementById('workout-notes').value.trim()
  });
  save('il_workouts',workouts);
  currentWorkout=[];
  showPage('dashboard');
}

// ══════════════════════════════════════
//  EXERCISE PICKER
// ══════════════════════════════════════
function openExercisePicker() { document.getElementById('exercise-picker-modal').classList.add('open'); document.getElementById('picker-search').value=''; renderPicker(); }
function closeExercisePicker() { document.getElementById('exercise-picker-modal').classList.remove('open'); }
function filterPicker() { renderPicker(document.getElementById('picker-search').value); }

function renderPicker(filter='') {
  const c=document.getElementById('picker-list'); const f=(filter||'').toLowerCase(); let html='';
  for (const [group,exList] of Object.entries(exercises)) {
    const filtered=exList.filter(e=>e.toLowerCase().includes(f));
    if (!filtered.length) continue;
    html+=`<div class="muscle-group-header">${group}</div>`;
    filtered.forEach(name => {
      html+=`<div class="exercise-lib-item" onclick="pickExercise('${name.replace(/'/g,"\\'")}')"><span class="exercise-lib-name">${name}</span><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary-light)" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></div>`;
    });
  }
  c.innerHTML=html||'<div class="empty-state"><p>No exercises found</p></div>';
}
function pickExercise(name) { currentWorkout.push({name,sets:[{weight:'',reps:''}]}); closeExercisePicker(); renderWorkoutForm(); }

// ══════════════════════════════════════
//  HISTORY
// ══════════════════════════════════════
function refreshHistory() {
  const c=document.getElementById('history-list');
  const sorted=[...workouts].sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(!sorted.length){c.innerHTML='<div class="empty-state"><p>No workout history yet.</p></div>';return;}
  c.innerHTML=sorted.map(w=>{
    const names=w.exercises.map(e=>e.name).join(', ');
    const sets=w.exercises.reduce((s,e)=>s+e.sets.length,0);
    const u=w.unit||'kg';
    const detail=w.exercises.map(e=>{
      const st=e.sets.map((s,si)=>`<div class="history-set-line">Set ${si+1}: ${s.weight}${u} × ${s.reps}</div>`).join('');
      return `<div class="history-exercise"><div class="history-exercise-name">${e.name}</div>${st}</div>`;
    }).join('');
    const notes=w.notes?`<div style="margin-top:8px;font-size:13px;color:var(--text-dim);font-style:italic;">"${esc(w.notes)}"</div>`:'';
    return `<div class="history-item" onclick="toggleDetail(this)"><div class="history-date">${formatDate(w.date)}</div><div class="history-summary">${names} · ${sets} sets</div><div class="history-detail">${detail}${notes}<button class="delete-workout" onclick="event.stopPropagation();deleteWorkout('${w.id}')">Delete Workout</button></div></div>`;
  }).join('');
}
function toggleDetail(el){el.querySelector('.history-detail').classList.toggle('open');}
function deleteWorkout(id){if(!confirm('Delete this workout?'))return;workouts=workouts.filter(w=>w.id!==id);save('il_workouts',workouts);refreshHistory();}

// ══════════════════════════════════════
//  PROGRESS
// ══════════════════════════════════════
function refreshProgress() {
  const exSet=new Set(); workouts.forEach(w=>w.exercises.forEach(e=>exSet.add(e.name)));
  const exList=[...exSet].sort();
  const chips=document.getElementById('progress-chips');
  if(!exList.length){chips.innerHTML='<div class="empty-state"><p>Log some workouts to see progress.</p></div>';document.getElementById('pr-section').innerHTML='';if(weightChart){weightChart.destroy();weightChart=null;}if(volumeChart){volumeChart.destroy();volumeChart=null;}return;}
  if(!selectedProgressExercise||!exSet.has(selectedProgressExercise)) selectedProgressExercise=exList[0];
  chips.innerHTML=exList.map(n=>`<div class="chip ${n===selectedProgressExercise?'active':''}" onclick="selectProgressExercise('${n.replace(/'/g,"\\'")}')">${n}</div>`).join('');
  renderPRSection();
  renderCharts();
}
function selectProgressExercise(n){selectedProgressExercise=n;refreshProgress();}

function renderPRSection() {
  const section=document.getElementById('pr-section');
  let maxW=0, maxWDate='', maxVol=0, maxE1rm=0;
  workouts.forEach(w=>{
    const ex=w.exercises.find(e=>e.name===selectedProgressExercise);
    if(!ex) return;
    ex.sets.forEach(s=>{
      if(s.weight>maxW){maxW=s.weight;maxWDate=w.date;}
      const e1rm=s.weight*(1+s.reps/30);
      if(e1rm>maxE1rm) maxE1rm=e1rm;
    });
    const vol=ex.sets.reduce((sum,s)=>sum+s.weight*s.reps,0);
    if(vol>maxVol) maxVol=vol;
  });
  if(!maxW){section.innerHTML='';return;}
  const u=unit;
  section.innerHTML=`
    <div class="pr-card"><div class="pr-icon">&#127942;</div><div class="pr-info"><div class="pr-label">Weight PR</div><div class="pr-value">${maxW} ${u}</div><div class="pr-date">${formatDate(maxWDate)}</div></div></div>
    <div class="onerm-row"><div class="onerm-card"><div class="onerm-val">${Math.round(maxE1rm)}</div><div class="onerm-label">Est. 1RM (${u})</div></div><div class="onerm-card"><div class="onerm-val">${maxVol.toLocaleString()}</div><div class="onerm-label">Best Volume</div></div></div>`;
}

function renderCharts() {
  const sorted=[...workouts].sort((a,b)=>new Date(a.date)-new Date(b.date));
  const data=[];
  sorted.forEach(w=>{
    const ex=w.exercises.find(e=>e.name===selectedProgressExercise);
    if(!ex) return;
    const maxW=Math.max(...ex.sets.map(s=>s.weight));
    const vol=ex.sets.reduce((sum,s)=>sum+s.weight*s.reps,0);
    const bestE1rm=Math.max(...ex.sets.map(s=>s.weight*(1+s.reps/30)));
    data.push({date:w.date,maxWeight:maxW,volume:vol,e1rm:Math.round(bestE1rm),unit:w.unit||'kg'});
  });
  const labels=data.map(d=>new Date(d.date+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}));

  const wCtx=document.getElementById('chart-weight').getContext('2d');
  if(weightChart)weightChart.destroy();
  weightChart=new Chart(wCtx,{type:'line',data:{labels,datasets:[
    {label:'Max Weight',data:data.map(d=>d.maxWeight),borderColor:'#6c5ce7',backgroundColor:'rgba(108,92,231,0.1)',borderWidth:2.5,pointRadius:4,pointHoverRadius:6,tension:0.3,fill:true},
    {label:'Est. 1RM',data:data.map(d=>d.e1rm),borderColor:'#f0a500',backgroundColor:'rgba(240,165,0,0.05)',borderWidth:2,pointRadius:3,borderDash:[5,5],tension:0.3,fill:false}
  ]},options:chartOpts(`Weight (${data[0]?.unit||unit})`,true)});

  const vCtx=document.getElementById('chart-volume').getContext('2d');
  if(volumeChart)volumeChart.destroy();
  volumeChart=new Chart(vCtx,{type:'bar',data:{labels,datasets:[{label:'Volume',data:data.map(d=>d.volume),backgroundColor:'rgba(0,206,201,0.6)',borderColor:'#00cec9',borderWidth:1.5,borderRadius:6}]},options:chartOpts('Volume',false)});
}

function chartOpts(yLabel,showLegend) {
  return {responsive:true,maintainAspectRatio:false,plugins:{legend:{display:showLegend,labels:{color:'#8888a0',usePointStyle:true,pointStyle:'circle',font:{size:11}}},tooltip:{backgroundColor:'rgba(20,20,32,0.95)',titleColor:'#a29bfe',bodyColor:'#e8e8f0',borderColor:'#2a2a40',borderWidth:1,cornerRadius:8,padding:10}},scales:{x:{ticks:{color:'#8888a0',font:{size:11}},grid:{color:'rgba(42,42,64,0.5)'}},y:{ticks:{color:'#8888a0',font:{size:11}},grid:{color:'rgba(42,42,64,0.5)'},title:{display:true,text:yLabel,color:'#8888a0',font:{size:12}}}}};
}

// ══════════════════════════════════════
//  UNIT TOGGLE
// ══════════════════════════════════════
function setUnit(u){unit=u;save('il_unit',u);document.getElementById('unit-kg').classList.toggle('active',u==='kg');document.getElementById('unit-lb').classList.toggle('active',u==='lb');renderWorkoutForm();}

// ══════════════════════════════════════
//  UTILS
// ══════════════════════════════════════
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}

// ══════════════════════════════════════
//  INIT
// ══════════════════════════════════════
(function init(){
  document.getElementById('unit-'+unit).classList.add('active');
  document.getElementById('unit-'+(unit==='kg'?'lb':'kg')).classList.remove('active');
  refreshDashboard();
})();
</script>
</body>
</html>
